# AGENTS.md

## Purpose
This document is the living handoff for engineers/agents working in this repository.
Update it whenever architecture, routes, data models, auth behavior, deployment, or developer commands change.

## Product Snapshot
Issue Prompt Tracker is a responsive web app + API for capturing project-specific issues/features with screenshots and converting them into AI-ready prompt bundles (`yaml + images`).

## Current Architecture
- Frontend: `apps/web` (React + Vite)
- Backend: `apps/api` (Fastify + Prisma)
- Shared package: `packages/shared` (prompt format/build helpers)
- Database: Postgres (Docker compose)
- Storage: filesystem uploads (configured via `UPLOAD_DIR`)

## Frontend Structure (Web)
- Auth screen: login/register
- Authenticated shell with routed pages:
  - `/issues`: issue/feature CRUD, image attachments, edit/delete
  - `/projects`: project CRUD + active project selection
  - `/categories`: global category CRUD
  - `/prompts`: filter items, copy prompt, download item/project prompt bundles
  - `/prompt-templates`: per-project template editor for `issue` / `feature` / `other` prompt variants
- Mobile-first navigation:
  - desktop sidebar nav
  - bottom tab nav on small screens
- PWA-enabled build (manifest + service worker via `vite-plugin-pwa`)
- Branding assets served from `apps/web/public/branding`

## Backend Auth + Access Control
- JWT auth endpoints:
  - `POST /api/auth/register`
  - `POST /api/auth/login`
  - `GET /api/auth/me`
- Roles:
  - `USER`: sees/manages own projects/items
  - `ADMIN`: sees/manages all projects/items
- Admin bootstrap on API startup using env:
  - `ADMIN_EMAIL`
  - `ADMIN_PASSWORD`
  - `ADMIN_NAME`
- JWT env:
  - `JWT_SECRET`
  - `JWT_EXPIRES_IN`

## Data Model Notes
- `User` model added with `role`
- `Project.ownerId` and `Item.ownerId` enforce per-user scope
- `PromptTemplate` stores per-project template text keyed by `CategoryKind` (`issue` / `feature` / `other`)
- Existing records are backfilled to admin owner on startup if owner is null

## Dev Commands
- Install: `npm install`
- Setup dev environment: `npm run setup:dev`
- Start app: `npm run dev`
- Run tests: `npm run test`
- Build all: `npm run build`
- Stop local DB: `npm run stop:devdb`

## Local Environment Notes
- Local Postgres host port: `55432`
- `.env` must include auth vars + DB URL

## Update Policy (Important)
When making changes, append an entry to **Change Log** below with:
1. Date (YYYY-MM-DD)
2. What changed
3. Any migration or env var impact
4. Any manual verification steps performed

## Change Log
### 2026-02-23
- Implemented auth layer (JWT, register/login/me) and role-based access (`ADMIN`/`USER`).
- Added user ownership to projects/items and migration `20260223211000_add_auth`.
- Added admin bootstrap and legacy ownership backfill on API startup.
- Fixed frontend JSON parse failure by setting `Content-Type: application/json` only for JSON-body requests.
- Rebuilt frontend UX into responsive routed pages (`/projects`, `/categories`, `/issues`, `/prompts`) with dedicated CRUD experiences and mobile navigation.
- Added Vite dev proxy for `/api` and `/uploads` to API server.
- Updated local DB host mapping to port `55432` to avoid conflicts.
- Verification performed:
  - `npm run test`
  - `npm run build`
- Fixed issue form UX regression on `/issues/:itemId/edit`:
  - existing saved screenshots now render in the Details tab (not just newly queued images)
  - added preview/remove controls for saved screenshots directly from the edit/manage form
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Added reusable screenshot copy UI component and wired it into both prompt workflows:
  - issue form Prompt tab now shows per-screenshot copy buttons
  - `/prompts` page now shows per-screenshot copy buttons for the selected item (same component reused)
  - screenshot list is rendered before prompt textarea on `/prompts` for immediate visibility
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
  - `npm run test`
- Added automatic system color-scheme adaptation for web UI:
  - introduced light/dark design tokens in `apps/web/src/styles.css` with `@media (prefers-color-scheme: dark)`
  - updated core surfaces/controls/overlays to use shared color variables so cards, forms, nav, modals, and dropzones switch theme automatically
  - added dark-mode-specific overrides for landing gradients, auth shells, alerts, and focus/active states
- Updated browser theme color metadata in `apps/web/index.html` with light/dark `theme-color` meta tags.
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Added agent-integration backend surface for skill-driven automations:
  - project-scoped API key management endpoints:
    - `POST /api/projects/:projectId/agent-keys`
    - `GET /api/projects/:projectId/agent-keys`
    - `DELETE /api/projects/:projectId/agent-keys/:keyId` (revoke)
  - new API-key-authenticated namespace:
    - `GET /api/agent/v1/project`
    - `GET /api/agent/v1/issues`
    - `GET /api/agent/v1/issues/:id`
    - `GET /api/agent/v1/issues/:id/prompt`
    - `POST /api/agent/v1/issues/:id/resolve`
    - `GET /api/agent/v1/issues/:issueId/images/:imageId`
  - agent issue list/detail supports optional prompt embedding and optional inline image payloads.
- Added Prisma models/enums for machine-key auth and resolution activity audit trail:
  - `AgentApiKey`
  - `ItemActivity`
  - `ItemActivityActorType`, `ItemActivityType`
- Added migration `20260224010000_add_agent_api_keys_and_item_activities`.
- Added env/config support for inline image size limit:
  - `AGENT_INLINE_IMAGE_MAX_BYTES` (default `262144`)
  - documented in `.env.example` and `README.md`.
- Migration/env impact:
  - new DB migration required before using agent APIs
  - new optional env var `AGENT_INLINE_IMAGE_MAX_BYTES`
- Verification performed:
  - `npm run prisma:generate -w apps/api`
  - `npm run build`
  - `npm run test`
- Updated `/prompts` copy behavior to match issue prompt tab:
  - `Copy Prompt` now attempts rich clipboard copy with prompt text + saved images
  - falls back to prompt text copy/manual fallback when image clipboard is unsupported or blocked
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Refined prompt copy fallback notices on issue prompt tab and `/prompts` page:
  - plural `images` message is now shown only when the item has multiple images
  - singular `image` message is shown for one-image fallback failures
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Added issue management prompt tab on `/issues/:itemId/edit`:
  - tab switch inside item form (`Details` / `Prompt`)
  - prompt tab supports copy prompt text and download item prompt bundle
  - prompt tab supports copy prompt + saved images to clipboard for direct paste into AI input fields (browser support dependent)
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Updated issue prompt tab copy behavior:
  - primary `Copy Prompt` action now attempts to copy prompt text + saved images in one click
  - added fallback to copy prompt text only when browser/app clipboard does not support image writes
  - secondary action now explicitly copies prompt text only
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Added project-scoped prompt template editor and API support:
  - new route `/prompt-templates` in web shell
  - API endpoints `GET/PUT /api/prompt-templates/:projectId`
  - prompt generation/export now resolve template kind from item category (`issue` / `feature` / `other`) and render placeholders
- Added Prisma migration `20260223235000_add_prompt_templates` with `PromptTemplate` table (`projectId + kind` unique).
- Migration/env impact:
  - DB migration required: `20260223235000_add_prompt_templates`
  - no new environment variables
- Verification performed:
  - `npm run test`
  - `npm run build`
  - `set -a; source .env; set +a; npm run prisma:migrate:deploy`
  - login/auth API smoke checks
- Normalized `docker-compose.yml` environment placeholders to sane defaults (`:-`) for smoother local/Coolify setup.
- Added Postgres variables to `.env.example` (`POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_HOST_PORT`).
- Expanded Coolify deployment docs in `README.md` with explicit Postgres + API env variable examples and required persistent volume mounts.
- Added baseline PWA support to web app (manifest, service worker registration, offline-ready shell).
- Generated and committed branded icon/image assets (`favicon`, apple icon, PWA icons, manifest screenshots).
- Added reusable asset generator script `npm run assets:generate -w apps/web`.
- Integrated brand mark logo into auth and app shell UI.
- Fixed Coolify web image build failure by changing `docker/Dockerfile.web` final stage copy to `COPY --from=0 ...` (stage-index copy) to avoid alias resolution issues after Coolify Dockerfile mutation for build secrets.
- Upgraded issue screenshot uploader UX to advanced queue flow:
  - drag-and-drop zone
  - clipboard image paste support on web (`Ctrl/Cmd+V` on focused dropzone)
  - pending image previews with per-image remove/clear queue
  - full-screen image preview modal for both queued and saved images
- Split CRUD UX into dedicated list/form routes:
  - Projects: `/projects`, `/projects/new`, `/projects/:projectId/edit`
  - Categories: `/categories`, `/categories/new`, `/categories/:categoryId/edit`
  - Issues: `/issues`, `/issues/new`, `/issues/:itemId/edit`
- Mobile shell UX updates:
  - removed topbar `Manage Projects` button (project selection handled by dropdown)
  - removed redundant topbar `Current: <project>` pill (active project shown only via selector)
  - replaced bottom mobile nav with burger-triggered sidebar drawer
  - reduced mobile dead space by removing bottom-nav route host spacing
- Action controls now use iconography:
  - icon-only quick actions for preview/remove/edit/delete
  - icon-leading labels for primary/secondary action buttons across pages
- Updated item validation rules:
  - `title` and `description` are now optional on create/update (empty values allowed)
  - `type`, `category`, `status`, and `priority` are enforced as required in the web form
- Improved validation UX on `/issues`:
  - invalid required fields are highlighted with inline red error messages
  - API validation errors are mapped into the global status alert with clearer messages
- Hardened API category validation for item create/update to return field-level validation issues when category IDs are invalid.
- Migration/env impact: none.
- Verification performed:
  - `npm run test`
  - `npm run build`
- Hardened Docker build reliability for Coolify by updating `docker/Dockerfile.api` and `docker/Dockerfile.web`:
  - include `package-lock.json` in the dependency layer
  - force devDependency install during image build with `npm install --include=dev` so workspace build tools are available even when Coolify injects build-time env/ARG values
- Migration/env impact: none.
- Verification performed:
  - `DOCKER_BUILDKIT=1 docker build --no-cache -f docker/Dockerfile.web -t aam-web-test:fix .`
  - `DOCKER_BUILDKIT=1 docker build --no-cache -f docker/Dockerfile.api -t aam-api-test:fix .`
- Fixed local upload path resolution to be stable regardless of process CWD:
  - API now resolves relative `UPLOAD_DIR` from `apps/api` root, not `process.cwd()`
  - backward compatibility added for legacy `UPLOAD_DIR=./apps/api/uploads` values
- Production safety default added in API env handling:
  - if `NODE_ENV=production` and `UPLOAD_DIR` is not set, API now defaults to `/data/uploads`
- Updated local env defaults:
  - `.env.example` now uses `UPLOAD_DIR=./uploads` (maps to `apps/api/uploads`)
  - README clarifies local upload path and keeps production/Coolify requirement as `UPLOAD_DIR=/data/uploads`
- Manual local data fix performed:
  - copied existing files from legacy `apps/api/apps/api/uploads` into `apps/api/uploads`
  - removed legacy nested directory after copy
- Migration/env impact:
  - no DB migration
  - recommended env value is `UPLOAD_DIR=./uploads` for local development
- Verification performed:
  - `npm run test`
  - `npm run build`
- Added a dedicated public landing experience before authentication:
  - new hero section with branded visuals, animated screenshot mockups, and feature chips
  - action-focused CTA buttons for `Sign In` and `Create Account` that jump users to the auth form
- Removed admin-credential hint text from login/register UI.
- Improved unauthenticated page responsiveness:
  - two-column desktop hero + auth card layout
  - stacked mobile layout with tighter spacing and touch-friendly CTA sizing
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Expanded item management on `/issues` (items list view) with full filtering controls:
  - filters for `search`, `type`, `status`, `priority`, `category`, and `tag`
  - clear-filters action to reset list filters in one click
- Added quick item status action buttons on each list card (`open`, `in progress`, `resolved`, `archived`).
- Added dedicated shared API endpoint for status changes (used for both issues and features):
  - `PATCH /api/items/:id/status` with body `{ "status": "<itemStatus>" }`
- Updated web API client with `updateItemStatus()` and wired list actions to the dedicated status endpoint.
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/api`
  - `npm run build -w apps/web`
  - `npm run test`
- Updated item card actions in `/issues` list view:
  - moved item-level `Edit` and `Delete` controls from bottom row to the top card header beside the item type chip
  - kept screenshot preview/remove controls unchanged inside the image block
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Updated sidebar brand kicker copy to `Issue & Feature Tracker` for clearer product meaning.
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- Replaced remaining legacy tracker labels across web metadata/PWA config:
  - updated `apple-mobile-web-app-title` in `apps/web/index.html`
  - updated PWA `short_name` in `apps/web/vite.config.ts`
- Migration/env impact: none.
- Verification performed:
  - searched for legacy tracker label text (no matches)
  - `npm run build -w apps/web`
- Hardened agent API key creation:
  - key prefix is now generated independently from the secret value
  - creation retries on rare DB unique-key collisions to avoid transient 500s
- Removed unused server code from agent API implementation (`FastifyReply` import and dead image serialization helper).
- Migration/env impact: none.
- Verification performed:
  - `npm run build`
  - `npm run test`
- Added web UI for managing project-scoped agent API keys:
  - project list now includes `Keys` action per project
  - new page route `/projects/:projectId/keys` to create/list/revoke keys
  - one-time token reveal panel after create with clipboard copy action
  - key list shows status (`Active`/`Revoked`), prefix, created time, and last-used time
- Added frontend API/types for key management endpoints:
  - `createProjectAgentKey()`
  - `getProjectAgentKeys()`
  - `revokeProjectAgentKey()`
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
  - `npm run test`
- 2026-02-24
- Hardened local dev startup flow to prevent frontend-only runs when API is down:
  - root `npm run dev` now starts web through `scripts/dev-web.sh`
  - `scripts/dev-web.sh` waits for API port readiness before launching Vite and fails with a clear message if API never comes up
  - root `npm run dev` now uses `concurrently --kill-others-on-fail` so a readiness failure cleanly terminates the API watcher too
- Migration/env impact:
  - no DB migration
  - optional dev-only override: `DEV_API_WAIT_SECONDS` (default 30) for API readiness timeout in `scripts/dev-web.sh`
- Verification performed:
  - `npm run dev`
  - `DATABASE_URL=postgresql://app:app@127.0.0.1:59999/aamtracker?schema=public DEV_API_WAIT_SECONDS=5 npm run dev`
- 2026-02-24
- Refined `/projects` list row actions for cleaner compact layout:
  - moved project row action controls to compact icon-only buttons (`Keys`, `Edit`, `Delete` via tooltip/aria labels)
  - kept project actions aligned to the right side of each row instead of stacking under the project name
  - added project-specific responsive overrides so action controls remain right-aligned on small screens
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- 2026-02-24
- Refined sidebar user identity card styling for clearer hierarchy and improved visual polish:
  - added avatar-style initial badge and grouped identity details
  - reorganized role/logout actions for better alignment and tap targets
  - improved card surface treatment and responsive behavior across desktop/mobile breakpoints
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- 2026-02-24
- Replaced persistent global status banners with timed toast notifications:
  - removed inline `alert` banner rendering from auth and authenticated shell layouts
  - added root-level toast pipeline for `reportError`/`reportNotice` messages with auto-dismiss after 5 seconds
  - added responsive toast placement: top-right on desktop, bottom on mobile
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- 2026-02-24
- Tightened mobile issue-card header action spacing on `/issues`:
  - updated mobile (`max-width: 880px`) `.item-top-actions` layout to avoid full-width `space-between` distribution
  - actions now stay compact/grouped so edit/delete buttons are not pushed far apart
- Migration/env impact: none.
- Verification performed:
  - `npm run build -w apps/web`
- 2026-02-24
- Expanded activity/audit surface across API, agent API, and web UI:
  - added project activity feed endpoint for JWT users: `GET /api/activities?projectId=...`
  - added item activity timeline endpoint for JWT users: `GET /api/items/:id/activities`
  - added agent polling activity feed endpoint: `GET /api/agent/v1/activities`
  - added agent per-issue timeline endpoint: `GET /api/agent/v1/issues/:id/activities`
  - added new web route `/activity` with filters/pagination and item jump-to-edit actions
  - added issue manage-form `Activity` tab on `/issues/:itemId/edit` with per-item timeline filtering/pagination
  - item mutation handlers now persist richer `ItemActivity` events for create/update/status/image upload/delete/reorder and agent resolve flows
- Added comprehensive markdown docs for agentic coding:
  - `apps/api/docs/agentic-coding.md`
  - `apps/api/docs/agent-api-reference.md`
  - `apps/api/docs/agent-polling-playbook.md`
  - new public docs endpoint: `GET /api/agent/v1/docs.md` (returns combined markdown with examples)
- Updated README agent integration docs/endpoint references and added new activity endpoints to API list.
- Migration/env impact:
  - new DB migration required: `20260224162000_expand_item_activity_types`
  - no new environment variables
- Verification performed:
  - `npm run build -w packages/shared`
  - `npm run prisma:generate -w apps/api`
  - `npm run build -w apps/api`
  - `npm run build -w apps/web`
  - `npm run test`
  - `npm run build`
